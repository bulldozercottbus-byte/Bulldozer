<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Chapter App</title>

<style>
    body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: #111;
        color: white;
    }

    header {
        background: black;
        padding: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #333;
    }

    .user-info {
        display: flex;
        gap: 15px;
        align-items: center;
        font-weight: bold;
    }

    .rank {
        color: orange;
    }

    button {
        background: orange;
        border: none;
        padding: 10px;
        cursor: pointer;
        font-weight: bold;
        width: 100%;
        margin-top: 5px;
    }

    .container {
        padding: 30px;
        max-width: 400px;
        margin: auto;
    }

    input {
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        background: #222;
        border: 1px solid #333;
        color: white;
    }

    .hidden { display: none; }

    .info-button {
        font-size: 22px;
        cursor: pointer;
        color: orange;
    }
</style>
</head>
<body>

<header id="header" class="hidden">
    <div class="user-info">
        <div class="rank" id="rankLabel">Hangaround</div>
        <div id="userName">Name</div>
        <div>R.Punkte: <span id="points">0</span></div>
    </div>

    <div class="info-button">ℹ</div>
</header>

<div class="container" id="authBox">
    <h2>Login / Registrierung</h2>

    <input type="text" id="name" placeholder="Name">
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Passwort">

    <button onclick="register()">Registrieren</button>
    <button onclick="login()">Login</button>

    <p id="status"></p>
</div>

<div class="container hidden" id="appBox">
    <h2>Willkommen</h2>
    <p>Phase 1 aktiv – Benutzer & Rangsystem läuft.</p>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

import { getFirestore, doc, setDoc, getDoc } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCnFEjFOcrpwjHtVnQ_-QssGtEhY__FzDk",
  authDomain: "bulldozer-f8a26.firebaseapp.com",
  projectId: "bulldozer-f8a26",
  storageBucket: "bulldozer-f8a26.firebasestorage.app",
  messagingSenderId: "576318762826",
  appId: "1:576318762826:web:7d812e32e152d64d425bb3",
  measurementId: "G-X3C80RP00D"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

window.register = async function() {

    const name = document.getElementById("name").value;
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;

    if (!name) {
        status("Bitte Namen eingeben");
        return;
    }

    try {
        const cred = await createUserWithEmailAndPassword(auth, email, password);

        await setDoc(doc(db, "users", cred.user.uid), {
            name: name,
            rank: "hangaround",
            rPoints: 0,
            approved: false,
            createdAt: new Date()
        });

        status("Registrierung erfolgreich");
    } catch (e) {
        status(e.message);
    }
}

window.login = async function() {

    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;

    try {
        await signInWithEmailAndPassword(auth, email, password);
    } catch (e) {
        status(e.message);
    }
}

onAuthStateChanged(auth, async (user) => {

    if (!user) return;

    document.getElementById("authBox").classList.add("hidden");
    document.getElementById("header").classList.remove("hidden");
    document.getElementById("appBox").classList.remove("hidden");

    const snap = await getDoc(doc(db, "users", user.uid));

    if (!snap.exists()) {
        status("Kein Benutzerprofil gefunden");
        return;
    }

    const data = snap.data();

    document.getElementById("userName").innerText = data.name;
    document.getElementById("points").innerText = data.rPoints;
    document.getElementById("rankLabel").innerText = formatRank(data.rank);
});

function formatRank(rank) {
    const map = {
        hangaround: "Hangaround",
        prospect: "Prospect",
        member: "Member",
        road_captain: "Road Captain",
        treasurer: "Treasurer",
        secretary: "Secretary",
        sergeant_at_arms: "Sergeant at Arms",
        vice_president: "Vice President",
        president: "President"
    };

    return map[rank] || rank;
}

function status(msg) {
    document.getElementById("status").innerText = msg;
}
</script>

</body>
</html>
