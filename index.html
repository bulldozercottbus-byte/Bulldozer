<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Club Intern â€“ Final</title>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<style>
body{margin:0;background:#0c0c0c;color:#eee;font-family:Arial}
.hidden{display:none}
nav{background:#000;padding:12px;display:flex;justify-content:space-between;align-items:center}
button{background:#333;color:#fff;border:none;padding:10px 14px;border-radius:6px;cursor:pointer}
button.primary{background:#b00000}
button.ok{background:#1faa59}
button.warn{background:#f5a623;color:#000}
.box{background:#1c1c1c;margin:12px;padding:12px;border-radius:10px}
.card{background:#222;padding:12px;border-radius:8px;margin-bottom:8px}
input,textarea,select{width:100%;background:#111;color:#fff;border:1px solid #333;padding:8px;border-radius:6px;margin-bottom:8px}
table{width:100%;border-collapse:collapse}
td,th{border-bottom:1px solid #333;padding:6px}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginView" style="text-align:center;margin-top:120px">
  <h1>Club Intern</h1>
  <input id="loginEmail" placeholder="E-Mail">
  <input id="loginPassword" type="password" placeholder="Passwort">
  <button class="primary" onclick="login()">Login</button>
  <p id="loginError" style="color:#f55"></p>
</div>

<!-- DASHBOARD -->
<div id="dashboardView" class="hidden">

<nav>
  <span id="navUser"></span>
  <div>
    <button onclick="generateMonthlyReport()">ğŸ“Š Monatsbericht</button>
    <button onclick="window.print()">ğŸ“„ PDF</button>
    <button onclick="logout()">Logout</button>
  </div>
</nav>

<div id="profileBox" class="box"></div>

<!-- DASHBOARD -->
<div id="boardDashboard" class="box hidden">
  <h2>ğŸ“Š Ãœbersicht</h2>
  <p>ğŸ’° Clubkasse: <b><span id="dashCash">0</span> â‚¬</b></p>
  <p>ğŸŸ¡ Offene Prospects: <b><span id="dashProspects">0</span></b></p>
  <p>ğŸ—³ï¸ Offene Abstimmungen: <b><span id="dashVotes">0</span></b></p>
  <p>ğŸï¸ Letzte Ausfahrt: <b><span id="dashRide">â€“</span></b></p>
</div>

<!-- HANGAROUND -->
<div id="hangaroundBox" class="box hidden">
  <h2>ğŸŸ¤ Hangaround</h2>
  <textarea id="hangNotes"></textarea>
  <button onclick="saveNotes('hang')">Speichern</button>
</div>

<!-- PROSPECT -->
<div id="prospectBox" class="box hidden">
  <h2>ğŸŸ¡ Prospect</h2>
  <textarea id="prospectNotes"></textarea>
  <button onclick="saveNotes('prospect')">Speichern</button>

  <h3>Ausfahrt eintragen</h3>
  <input type="date" id="pRideDate">
  <textarea id="pRideText"></textarea>
  <button onclick="addProspectRide()">Eintragen</button>

  <div id="prospectRideList"></div>
</div>

<!-- ROAD CAPTAIN -->
<div id="roadCaptainBox" class="box hidden">
  <h2>ğŸï¸ Road Captain</h2>
  <input id="rideTitle" placeholder="Titel">
  <input id="rideTime" placeholder="Datum/Uhrzeit">
  <textarea id="ridePlan"></textarea>
  <button onclick="addRide()">Speichern</button>
</div>

<div id="rideView" class="box hidden">
  <h2>ğŸ“ Ausfahrten</h2>
  <div id="rideList"></div>
</div>

<!-- CONFIRM -->
<div id="confirmBox" class="box hidden">
  <h2>âœ… Prospect bestÃ¤tigen</h2>
  <div id="confirmList"></div>
</div>

<!-- SECRETARY -->
<div id="secretaryBox" class="box hidden">
  <h2>ğŸ“ Secretary</h2>
  <textarea id="secText"></textarea>
  <button onclick="saveSecretary()">Speichern</button>
</div>

<!-- TREASURER -->
<div id="treasurerBox" class="box hidden">
  <h2>ğŸ’° Clubkasse</h2>

  <div id="cashForm" class="hidden">
    <select id="cashType">
      <option value="einnahme">Einnahme</option>
      <option value="ausgabe">Ausgabe</option>
      <option value="support">Support</option>
    </select>
    <input id="cashAmount" placeholder="Betrag">
    <input id="cashDesc" placeholder="Beschreibung">
    <button onclick="addCash()">Buchen</button>
  </div>

  <p><b>Stand:</b> <span id="cashTotal">0</span> â‚¬</p>

  <div id="cashHistoryBox" class="hidden">
    <table>
      <thead>
        <tr><th>Datum</th><th>Typ</th><th>Betrag</th><th>Text</th><th>Von</th></tr>
      </thead>
      <tbody id="cashHistory"></tbody>
    </table>
  </div>
</div>

<!-- VOTES -->
<div id="voteBox" class="box hidden">
  <h2>ğŸ—³ï¸ Abstimmungen</h2>
  <div id="voteCreateBox" class="hidden">
    <input id="voteTitle" placeholder="Thema">
    <button onclick="createVote()">Erstellen</button>
  </div>
  <div id="voteList"></div>
</div>

<!-- ADMIN -->
<div id="adminBox" class="box hidden">
  <h2>ğŸ”§ Admin</h2>
  <div id="adminUserList"></div>
</div>

</div>

<script>
// ================= FIREBASE =================
const firebaseConfig = {
  apiKey: "AIzaSyCnFEjFOcrpwjHtVnQ_-QssGtEhY__FzDk",
  authDomain: "bulldozer-f8a26.firebaseapp.com",
  projectId: "bulldozer-f8a26"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let currentUser = null;

// ================= AUTH =================
function login(){
  auth.signInWithEmailAndPassword(loginEmail.value, loginPassword.value)
  .catch(e=>loginError.innerText=e.message);
}
function logout(){ auth.signOut(); }

auth.onAuthStateChanged(user=>{
  if(!user){
    loginView.classList.remove("hidden");
    dashboardView.classList.add("hidden");
    return;
  }

  loginView.classList.add("hidden");
  dashboardView.classList.remove("hidden");

  db.collection("users").doc(user.uid).get().then(doc=>{
    currentUser = doc.data();
    navUser.innerText = currentUser.name+" ("+currentUser.rank+")";
    profileBox.innerHTML = `<b>${currentUser.name}</b><br>${currentUser.rank}`;

    if(currentUser.isAdmin || ["secretary","treasurer","vice_president","president"].includes(currentUser.rank)){
      boardDashboard.classList.remove("hidden");
      loadDashboard();
    }

    if(currentUser.rank==="hangaround") hangaroundBox.classList.remove("hidden");
    if(currentUser.rank==="prospect"){ prospectBox.classList.remove("hidden"); loadMyProspectRides(); }
    if(currentUser.rank==="road_captain") roadCaptainBox.classList.remove("hidden");

    if(["prospect","member","road_captain","sergeant_at_arms","secretary","treasurer","vice_president","president"].includes(currentUser.rank)){
      rideView.classList.remove("hidden");
      loadRides();
    }

    if(currentUser.isAdmin || ["secretary","sergeant_at_arms"].includes(currentUser.rank)){
      confirmBox.classList.remove("hidden");
      loadConfirmations();
    }

    if(currentUser.rank==="secretary") secretaryBox.classList.remove("hidden");

    if(currentUser.isAdmin || ["member","sergeant_at_arms","treasurer","vice_president","president"].includes(currentUser.rank)){
      treasurerBox.classList.remove("hidden");
      loadCash();
    }

    if(currentUser.isAdmin || currentUser.rank==="treasurer"){
      cashForm.classList.remove("hidden");
    }

    if(currentUser.isAdmin || ["treasurer","vice_president","president"].includes(currentUser.rank)){
      cashHistoryBox.classList.remove("hidden");
    }

    if(currentUser.isAdmin || ["member","secretary","treasurer","sergeant_at_arms","vice_president","president"].includes(currentUser.rank)){
      voteBox.classList.remove("hidden");
      loadVotes();
    }

    if(currentUser.isAdmin || currentUser.rank==="secretary"){
      voteCreateBox.classList.remove("hidden");
    }

    if(currentUser.isAdmin){
      adminBox.classList.remove("hidden");
      loadAdminUsers();
    }
  });
});

// ================= FUNCTIONS =================
function saveNotes(type){
  const text = type==="hang"?hangNotes.value:prospectNotes.value;
  db.collection("notes").doc(auth.currentUser.uid).set({text},{merge:true});
}

function addProspectRide(){
  db.collection("prospect_rides").add({
    userId: auth.currentUser.uid,
    name: currentUser.name,
    date: pRideDate.value,
    text: pRideText.value,
    status:"offen",
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });
}

function loadMyProspectRides(){
  prospectRideList.innerHTML="";
  db.collection("prospect_rides").where("userId","==",auth.currentUser.uid)
  .onSnapshot(s=>{
    prospectRideList.innerHTML="";
    s.forEach(d=>{
      const r=d.data();
      prospectRideList.innerHTML+=`<div class="card">${r.date} â€“ ${r.text} (${r.status})</div>`;
    });
  });
}

function addRide(){
  db.collection("rides").add({
    title:rideTitle.value,
    time:rideTime.value,
    plan:ridePlan.value,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });
}

function loadRides(){
  rideList.innerHTML="";
  db.collection("rides").orderBy("createdAt","desc").onSnapshot(s=>{
    rideList.innerHTML="";
    s.forEach(d=>{
      const r=d.data();
      rideList.innerHTML+=`<div class="card">${r.title} â€“ ${r.time}</div>`;
    });
  });
}

function loadConfirmations(){
  confirmList.innerHTML="";
  db.collection("prospect_rides").where("status","==","offen").onSnapshot(s=>{
    confirmList.innerHTML="";
    s.forEach(d=>{
      const r=d.data();
      confirmList.innerHTML+=`
        <div class="card">
          ${r.name} â€“ ${r.date}<br>${r.text}<br>
          <button class="ok" onclick="d.ref.update({status:'bestÃ¤tigt'})">BestÃ¤tigen</button>
          <button class="warn" onclick="d.ref.update({status:'abgelehnt'})">Ablehnen</button>
        </div>`;
    });
  });
}

function saveSecretary(){
  db.collection("secretary_docs").add({text:secText.value,by:currentUser.name});
}

function addCash(){
  db.collection("cash").add({
    amount:Number(cashAmount.value),
    type:cashType.value,
    desc:cashDesc.value,
    by:currentUser.name,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });
}

function loadCash(){
  let sum=0;
  cashHistory.innerHTML="";
  db.collection("cash").orderBy("createdAt","desc").onSnapshot(s=>{
    sum=0;
    cashHistory.innerHTML="";
    s.forEach(d=>{
      const c=d.data();
      sum+=c.amount;
      cashHistory.innerHTML+=`<tr><td>${c.type}</td><td>${c.amount}</td><td>${c.desc}</td><td>${c.by}</td></tr>`;
    });
    cashTotal.innerText=sum.toFixed(2);
  });
}

function createVote(){
  db.collection("votes").add({title:voteTitle.value,open:true});
  voteTitle.value="";
}

function vote(id,choice){
  db.collection("votes").doc(id).collection("results").doc(auth.currentUser.uid).set({choice});
}

function loadVotes(){
  voteList.innerHTML="";
  db.collection("votes").onSnapshot(s=>{
    voteList.innerHTML="";
    s.forEach(d=>{
      const v=d.data();
      voteList.innerHTML+=`<div class="card">${v.title}</div>`;
    });
  });
}

function loadDashboard(){
  db.collection("cash").onSnapshot(s=>{
    let t=0; s.forEach(d=>t+=d.data().amount);
    dashCash.innerText=t.toFixed(2);
  });
  db.collection("prospect_rides").where("status","==","offen")
    .onSnapshot(s=>dashProspects.innerText=s.size);
  db.collection("votes").where("open","==",true)
    .onSnapshot(s=>dashVotes.innerText=s.size);
  db.collection("rides").orderBy("createdAt","desc").limit(1)
    .onSnapshot(s=>{
      if(s.docs[0]) dashRide.innerText=s.docs[0].data().title;
    });
}

function loadAdminUsers(){
  adminUserList.innerHTML="";
  db.collection("users").onSnapshot(s=>{
    adminUserList.innerHTML="";
    s.forEach(d=>{
      const u=d.data();
      adminUserList.innerHTML+=`
        <div class="card">
          ${u.name}
          <select onchange="d.ref.update({rank:this.value})">
            <option>${u.rank}</option>
            <option>hangaround</option><option>prospect</option><option>member</option>
            <option>road_captain</option><option>sergeant_at_arms</option>
            <option>secretary</option><option>treasurer</option>
            <option>vice_president</option><option>president</option>
          </select>
        </div>`;
    });
  });
}

function generateMonthlyReport(){
  const m=new Date().getMonth(), y=new Date().getFullYear();
  let sum=0;
  db.collection("cash").get().then(s=>{
    s.forEach(d=>{
      const c=d.data();
      if(c.createdAt){
        const dt=c.createdAt.toDate();
        if(dt.getMonth()===m && dt.getFullYear()===y) sum+=c.amount;
      }
    });
    alert(`Monat ${m+1}/${y}: ${sum.toFixed(2)} â‚¬`);
  });
}
</script>

</body>
</html>
